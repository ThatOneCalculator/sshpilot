name: Build macOS Binary 2

on: [push, pull_request]

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: mac

      - name: Install Homebrew dependencies
        run: |
          brew update
          brew install python gtk4 libadwaita vte3 pygobject3 py3cairo gobject-introspection adwaita-icon-theme pkg-config glib graphene icu4c sshpass
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/lib" >> $GITHUB_PATH

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install paramiko cryptography secretstorage matplotlib py2app pygobject 'setuptools<81'

      - name: Patch secretstorage for macOS
        run: |
          if ! python -c "import secretstorage" >/dev/null 2>&1; then
            python - <<'PY'
from pathlib import Path
p = Path('sshpilot/connection_manager.py')
if p.exists():
    s = p.read_text()
    s = s.replace('import secretstorage', 'try:\n    import secretstorage\nexcept Exception:\n    secretstorage = None')
    p.write_text(s)
    print('Patched', p)
else:
    print('No connection_manager.py found, skipping patch')
PY
          fi

      - name: Set up environment for PyGObject
        run: |
          export GI_TYPELIB_PATH=/opt/homebrew/lib/girepository-1.0
          export DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/opt/gtk4/lib:/opt/homebrew/opt/glib/lib:/opt/homebrew/opt/vte3/lib:/opt/homebrew/opt/icu4c/lib:/opt/homebrew/opt/graphene/lib:/opt/homebrew/lib
          export XDG_DATA_DIRS=/opt/homebrew/share
          echo "GI_TYPELIB_PATH=/opt/homebrew/lib/girepository-1.0" >> $GITHUB_ENV
          echo "DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/opt/gtk4/lib:/opt/homebrew/opt/glib/lib:/opt/homebrew/opt/vte3/lib:/opt/homebrew/opt/icu4c/lib:/opt/homebrew/opt/graphene/lib:/opt/homebrew/lib" >> $GITHUB_ENV
          echo "XDG_DATA_DIRS=/opt/homebrew/share" >> $GITHUB_ENV

      - name: Verify PyGObject installation
        run: |
          python -c "import gi; gi.require_version('Gtk', '4.0'); from gi.repository import Gtk; print('GTK version:', Gtk.get_major_version())"
          pkg-config --modversion gobject-introspection-1.0
          ls -l /opt/homebrew/lib/girepository-1.0
          ls -l /opt/homebrew/share/glib-2.0/schemas
          ls -l /opt/homebrew/opt/*/lib/*.dylib

      - name: Build app bundle
        run: PYTHONVERBOSE=1 python setup.py py2app

      - name: Copy additional GTK libraries
        run: |
          mkdir -p dist/sshpilot.app/Contents/Frameworks
          cp /opt/homebrew/opt/gtk4/lib/libgtk-4.1.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/glib/lib/libglib-2.0.0.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/vte3/lib/libvte-2.91-gtk4.0.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/icu4c/lib/libicudata.75.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/icu4c/lib/libicui18n.75.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/icu4c/lib/libicuio.75.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/icu4c/lib/libicutu.75.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/icu4c/lib/libicuuc.75.dylib dist/sshpilot.app/Contents/Frameworks/
          cp /opt/homebrew/opt/graphene/lib/libgraphene-1.0.0.dylib dist/sshpilot.app/Contents/Frameworks/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: dist/*.app