name: CI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  flatpak:
    name: "Flatpak"
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update manifest with tag and commit
      run: |
        # Extract version from tag (remove 'v' prefix)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Updating manifest for version: $VERSION"
        
        # Get the commit hash for this specific tag
        COMMIT_HASH=$(git rev-parse ${{ github.ref_name }})
        echo "Commit hash for tag ${{ github.ref_name }}: $COMMIT_HASH"
        
        # Update tag in manifest
        sed -i "s/tag: v[0-9.]*/tag: v$VERSION/" io.github.mfat.sshpilot.yaml
        
        # Update commit hash in manifest
        sed -i "s/commit: [a-f0-9]*/commit: $COMMIT_HASH/" io.github.mfat.sshpilot.yaml
        
        # Show the updated manifest
        echo "Updated manifest:"
        grep -A 2 "sources:" io.github.mfat.sshpilot.yaml
    
    - name: Commit updated manifest
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add io.github.mfat.sshpilot.yaml
        git commit -m "Update manifest for release ${{ github.ref_name }} [skip ci]" || echo "No changes to commit"
        git push
    
    - name: Build Flatpak bundle
      run: |
        # Extract version from tag (remove 'v' prefix)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Building Flatpak bundle for version: $VERSION"
        
        # Build the Flatpak bundle
        flatpak-builder --force-clean --repo=repo --state-dir=.flatpak-builder build-dir io.github.mfat.sshpilot.yaml
        flatpak build-bundle repo sshpilot_${VERSION}-1.flatpak io.github.mfat.sshpilot
