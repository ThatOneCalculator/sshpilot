name: Gemini Build macOS Application

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the "mac" branch
  push:
    branches: [ "mac" ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-macos:
    # The type of runner that the job will run on
    runs-on: macos-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up the Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Cache Homebrew dependencies to speed up builds
      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/gemini-build-mac.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      # Step 4: Install system-level dependencies via Homebrew
      - name: Install Dependencies via Homebrew
        run: |
          brew install python3 gtk4 libadwaita pygobject3 adwaita-icon-theme pkg-config

      # Step 5: Install Python application dependencies
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # Step 6: Run the PyInstaller build using the custom spec file
      - name: Build macOS App Bundle
        run: pyinstaller sshPilot.spec

      # Step 7: Package the.app bundle into a zip archive for easier download
      - name: Archive the application bundle
        run: |
          cd dist
          zip -r sshpilot-macos.zip sshpilot.app

      # Step 8: Upload the final artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sshpilot-macos-app
          path: dist/sshpilot-macos.zip