name: Gemini Build macOS Application

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the "mac" branch
  push:
    branches: [ "mac" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-macos:
    # The type of runner that the job will run on
    runs-on: macos-13

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: mac

      # Step 2: Set up the Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Cache Homebrew dependencies to speed up builds
      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/gemini-build-mac.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      # Step 4: Install system-level dependencies via Homebrew
      - name: Install Dependencies via Homebrew
        run: |
          brew install python3 gtk4 libadwaita pygobject3 py3cairo vte3 gobject-introspection adwaita-icon-theme pkg-config glib graphene icu4c sshpass

      # Step 5: Install Python application dependencies
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          # Install only essential dependencies to avoid numpy/matplotlib universal binary issues
          # Note: pygobject will be provided by Homebrew (universal binary)
          pip install paramiko cryptography secretstorage keyring
          pip install pyinstaller
          # Verify numpy/matplotlib are not installed
          pip list | grep -E "(numpy|matplotlib)" || echo "Good: numpy/matplotlib not installed"
          # Set up environment for Homebrew PyGObject
          export PYTHONPATH="/opt/homebrew/lib/python3.12/site-packages:$PYTHONPATH"
          echo "Checking PyGObject availability:"
          python -c "import sys; sys.path.insert(0, '/opt/homebrew/lib/python3.12/site-packages'); import gi; print('PyGObject available')" || echo "PyGObject not found"

      # Step 5.5: Patch secretstorage for macOS compatibility
      - name: Patch secretstorage for macOS
        run: |
          if ! python -c "import secretstorage" >/dev/null 2>&1; then
            if grep -q "^import secretstorage$" sshpilot/connection_manager.py 2>/dev/null; then
              echo "Patching secretstorage import for macOS..."
              python - <<'PY'
          from pathlib import Path
          p = Path('sshpilot/connection_manager.py')
          s = p.read_text()
          s = s.replace('import secretstorage', 'try:\n    import secretstorage\nexcept Exception:\n    secretstorage = None')
          p.write_text(s)
          print('Patched', p)
          PY
            fi
          fi

      # Step 6: Set up environment and build app bundle
      - name: Build macOS App Bundle
        run: |
          # Set up environment for PyInstaller
          export BREW_PREFIX="$(brew --prefix)"
          export GI_TYPELIB_PATH="$BREW_PREFIX/lib/girepository-1.0"
          export DYLD_FALLBACK_LIBRARY_PATH="$BREW_PREFIX/opt/gtk4/lib:$BREW_PREFIX/opt/glib/lib:$BREW_PREFIX/opt/vte3/lib:$BREW_PREFIX/opt/icu4c/lib:$BREW_PREFIX/opt/graphene/lib:$BREW_PREFIX/lib"
          export XDG_DATA_DIRS="$BREW_PREFIX/share"
          
          # Debug: Check what Python packages are available
          echo "Installed Python packages:"
          pip list
          
          # Generate PyInstaller spec file dynamically
          cat > sshpilot-dynamic.spec << 'EOF'
          # -*- mode: python ; coding: utf-8 -*-
          import os
          import subprocess
          
          # Get Homebrew prefix dynamically
          try:
              brew_prefix = subprocess.check_output(['brew', '--prefix']).decode().strip()
          except:
              brew_prefix = '/opt/homebrew'  # Default for Apple Silicon
          
          a = Analysis(
              ['run.py'],
              pathex=[f'{brew_prefix}/lib/python3.12/site-packages'],  # Include Homebrew PyGObject path
              binaries=[
                  # Include essential GTK4 libraries for PyGObject
                  (f'{brew_prefix}/lib/libgirepository-1.0.dylib', '.'),
                  (f'{brew_prefix}/lib/libgobject-2.0.dylib', '.'),
                  (f'{brew_prefix}/lib/libglib-2.0.dylib', '.'),
                  (f'{brew_prefix}/lib/libgio-2.0.dylib', '.'),
                  (f'{brew_prefix}/lib/libgtk-4.dylib', '.'),
                  (f'{brew_prefix}/lib/libadwaita-1.dylib', '.'),
              ],
              datas=[
                  # Include essential GTK data files
                  (f'{brew_prefix}/share/glib-2.0/schemas', 'share/glib-2.0/schemas'),
                  (f'{brew_prefix}/share/icons', 'share/icons'),
                  (f'{brew_prefix}/lib/girepository-1.0', 'lib/girepository-1.0'),
              ],
              hiddenimports=[
                  'paramiko',
                  'cryptography',
                  'secretstorage',
                  'keyring',
                  'gi',
                  'gi.repository',
                  'gi.repository.Gtk',
                  'gi.repository.Adw',
                  'gi.repository.GLib',
                  'gi.repository.Gio',
                  'gi.repository.GObject',
                  'gi.repository.Vte',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=['PIL', 'Pillow', 'matplotlib', 'numpy', 'matplotlib.*', 'numpy.*', '_cffi_backend'],
              noarchive=False,
              optimize=0,
          )
          
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              [],
              exclude_binaries=True,
              name='sshPilot',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=False,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=True,
              target_arch=None,  # Build for native architecture only
              codesign_identity=None,
              entitlements_file=None,
          )
          
          coll = COLLECT(
              exe,
              a.binaries,
              a.datas,
              strip=False,
              upx=False,
              upx_exclude=[],
              name='sshPilot',
          )
          
          app = BUNDLE(
              coll,
              name='sshpilot.app',
              icon=None,
              bundle_identifier='io.github.mfat.sshpilot',
              info_plist={
                  'NSPrincipalClass': 'NSApplication',
                  'NSAppleScriptEnabled': False,
                  'CFBundleDocumentTypes': [],
                  'NSHighResolutionCapable': True,
                  'LSMinimumSystemVersion': '10.15.0',
                  'NSRequiresAquaSystemAppearance': False,
              },
          )
          EOF
          
          # Set up environment for PyGObject
          export PYTHONPATH="/opt/homebrew/lib/python3.12/site-packages:$PYTHONPATH"
          export GI_TYPELIB_PATH="/opt/homebrew/lib/girepository-1.0"
          export DYLD_LIBRARY_PATH="/opt/homebrew/lib:$DYLD_LIBRARY_PATH"
          
          # Build app bundle for native architecture (x86_64 on macos-13)
          pyinstaller --clean sshpilot-dynamic.spec

      # Step 7: Package the.app bundle into a zip archive for easier download
      - name: Archive the application bundle
        run: |
          cd dist
          zip -r sshpilot-macos.zip sshpilot.app

      # Step 8: Upload the final artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-app-pyinstaller
          path: dist/sshpilot-macos.zip
