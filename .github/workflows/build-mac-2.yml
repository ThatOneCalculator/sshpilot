name: Build macOS Binary 2

on: [push, pull_request]

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: mac

      - name: Install Homebrew dependencies
        run: |
          brew update
          brew install python gtk4 libadwaita vte3 adwaita-icon-theme gobject-introspection pygobject3 sshpass
          # Ensure Homebrew paths are available
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/lib" >> $GITHUB_PATH
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install paramiko cryptography secretstorage matplotlib py2app pygobject 'setuptools<81'
      - name: Set up environment for PyGObject
        run: |
          # Set environment variables for GObject Introspection
          export GI_TYPELIB_PATH=/opt/homebrew/lib/girepository-1.0
          export DYLD_LIBRARY_PATH=/opt/homebrew/lib:$DYLD_LIBRARY_PATH
          echo "GI_TYPELIB_PATH=/opt/homebrew/lib/girepository-1.0" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=/opt/homebrew/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
      - name: Verify PyGObject installation
        run: |
          python -c "import gi; gi.require_version('Gtk', '4.0'); from gi.repository import Gtk; print('GTK version:', Gtk.get_major_version())"
          pkg-config --modversion gobject-introspection-1.0
          ls -l /opt/homebrew/lib/girepository-1.0
          ls -l /opt/homebrew/share/glib-2.0/schemas
          echo "Checking for icon theme paths:"
          ls -la /opt/homebrew/share/ | grep -i adwaita || echo "No adwaita directory found"
          ls -la /opt/homebrew/share/icons/ | head -10 || echo "No icons directory found"
      - name: Build app bundle
        run: ARCHFLAGS="-arch x86_64 -arch arm64" python setup.py py2app --no-chdir

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: dist/*.app